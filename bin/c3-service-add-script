#!/usr/bin/env node

var program = require('commander');
var Client = require('node-rest-client').Client;
var config = require('./c3-config');
var YAML = require('yamljs');

var client = new Client();

program
  .option('-v, --event <eventname>', 'Create a service stack from file')
  .option('-f, --filename <filename>', 'Create a service stack from file')
  .option('-e, --env <environmentName>', 'Create an application stack for the environment')
  .parse(process.argv);

var name = program.args;

var url = config.Url + "/service/addScript";
var args = { headers: {"Content-Type": "application/json"}, data: {} }

if(name) {
  args.data.name = name[0];
}

if (program.filename) {
  // TODO: Change this to just stream the file into the string.
  args.data.script = YAML.load(program.filename);
}

if (program.event) {
  args.data.event = program.event;
}

if (program.env) {
  args.data.env = program.env;
}

client.post(url, args, function (data, response) {
  // parsed response body as js object
  if(data.error) {
    console.error(data.error);
  }
  else {
    console.log("Script " + program.event + " has been added to the service " + data.service.name);
  }
});
